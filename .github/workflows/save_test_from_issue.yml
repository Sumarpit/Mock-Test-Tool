name: Save Test from Issue

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  issues: write

jobs:
  save-json:
    if: contains(github.event.issue.labels.*.name, 'new-test')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Save JSON and Update Manifest
        env:
          JSON_CONTENT: ${{ github.event.issue.body }}
          FILE_NAME: ${{ github.event.issue.title }}
        run: |
          # 1. Define Target Path (e.g., tests/upsc/Test1.json)
          TARGET_PATH="tests/$FILE_NAME"
          
          # 2. Create the subdirectory if it doesn't exist
          mkdir -p "$(dirname "$TARGET_PATH")"

          # 3. Save the File
          echo "$JSON_CONTENT" > "$TARGET_PATH"
          
          # 4. Validate JSON
          if jq -e . "$TARGET_PATH" >/dev/null 2>&1; then
            echo "Valid JSON detected."
          else
            echo "Error: Invalid JSON format."
            rm "$TARGET_PATH"
            exit 1
          fi

          # 5. Update Global Manifest (tests/test_manifest.json)
          # This scans ALL json files in ALL subfolders of tests/
          echo "[" > tests/test_manifest.json
          first=true
          
          # Find all .json files inside tests/ and its subfolders
          find tests -name "*.json" | sort | while read file; do
            # Skip the manifest file itself
            if [ "$(basename "$file")" != "test_manifest.json" ]; then
              if [ "$first" = true ]; then
                first=false
              else
                echo "," >> tests/test_manifest.json
              fi
              
              FILENAME=$(basename "$file")
              NAME="${FILENAME%.*}"
              # We create a simple entry. 
              # Note: In a real app, you might want to parse the file to get 'section' or 'qCount'
              echo "{\"name\": \"$NAME\", \"filename\": \"$FILENAME\", \"path\": \"$file\"}" >> tests/test_manifest.json
            fi
          done
          echo "]" >> tests/test_manifest.json

      - name: Commit and Push
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          
          git add .
          git commit -m "Added test: ${{ github.event.issue.title }}"
          git push

      - name: Close Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUM: ${{ github.event.issue.number }}
        run: |
          gh issue close $ISSUE_NUM --comment "âœ… Success! Saved to: tests/${{ github.event.issue.title }}"

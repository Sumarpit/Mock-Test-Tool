jobs:
  save-json:
    if: contains(github.event.issue.labels.*.name, 'new-test')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Save JSON
        env:
          JSON_CONTENT: ${{ github.event.issue.body }}
          FILE_NAME: ${{ github.event.issue.title }}
        run: |
          # Define the full target path (e.g., tests/upsc/test.json)
          TARGET_PATH="tests/$FILE_NAME"
          
          # 1. Create the specific subdirectory (e.g., tests/upsc)
          mkdir -p "$(dirname "$TARGET_PATH")"

          # 2. Save the New Test File
          echo "$JSON_CONTENT" > "$TARGET_PATH"
          
          # 3. Validation: Check if it is valid JSON
          if jq -e . "$TARGET_PATH" >/dev/null 2>&1; then
            echo "Valid JSON detected."
          else
            echo "Error: Invalid JSON format."
            rm "$TARGET_PATH"
            exit 1
          fi

          # 4. Update Manifest (Optional: This updates the ROOT manifest only)
          # If you want specific manifests, logic needs to be more complex.
          # For now, we ensure the global list is updated.
          echo "[" > tests/test_manifest.json
          first=true
          # Find all JSON files recursively in tests/
          find tests -name "*.json" | while read file; do
            if [ "$(basename "$file")" != "test_manifest.json" ]; then
              if [ "$first" = true ]; then
                first=false
              else
                echo "," >> tests/test_manifest.json
              fi
              
              FILENAME=$(basename "$file")
              # Calculate relative path for ID if needed, or just use filename
              NAME="${FILENAME%.*}"
              echo "{\"name\": \"$NAME\", \"filename\": \"$FILENAME\", \"qCount\": 0}" >> tests/test_manifest.json
            fi
          done
          echo "]" >> tests/test_manifest.json

      - name: Commit and Push
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          
          # Add the new test file (handles spaces in paths)
          git add "tests/${{ github.event.issue.title }}"
          
          # Add manifest if changed
          git add tests/test_manifest.json
          
          git commit -m "Added test: ${{ github.event.issue.title }}"
          git push

      - name: Close Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUM: ${{ github.event.issue.number }}
        run: |
          gh issue close $ISSUE_NUM --comment "âœ… Success! Saved to: tests/${{ github.event.issue.title }}"
